---

stages:
  - Build
  - Deploy

variables:
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_TLS_VERIFY: 1
  DOCKER_CERT_PATH: "${DOCKER_TLS_CERTDIR}/client"

Build:
  stage: Build
  image:
    name: gcr.io/kaniko-project/executor:v1.17.0-debug
    entrypoint: [""]
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${$CI_COMMIT_SHA}"
      --destination $CI_REGISTRY_IMAGE:latest
  tags:
   - k8s
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      changes:
        - Dockerfile
        - src/**/*
      # when: manual
      # allow_failure: true

Deploy:
  stage: Deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: ['']
  script:
    - kubectl config use-context ${KUBE_CONTEXT}
    - |
      echo "Replace Secret Variables"
      (echo "cat <<EOF"; cat k8s/secrets.yaml; echo EOF) | sh > k8s/tmp_secrets.yaml && mv k8s/tmp_secrets.yaml k8s/secrets.yaml
    - kubectl apply -f k8s

  tags:
    - k8s
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
  environment:
    name: production
    url: https://go-training.ingmg.com
